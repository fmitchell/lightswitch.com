<?php

/**
 * HOOKS
 */

function bxdev_sales_preprocess_page($variables){
	// $account = new stdClass();
	// $account->name = 'wandoledzep@gmail.com';
	// $account->mail = 'wandoledzep@gmail.com';
	// $account->pass = user_password();
	// $account->roles = array(2 => 'authenticated user', 7 => 'client');
	// $user = user_save($account);
	// 
	// $profile = profile_create(array('user' => $user, 'type' => 'client'));
	// $profile->field_profile_test['und'][0]['value'] = 'hello dood';
	// profile2_save($profile);
	// 
	// dpm($profile);
}

/**
 * Implements hook_menu().
 */
function bxdev_sales_menu() {
  $items['sales/add/client'] = array(
    'title' => t('Create a New Video Project'),
		'page callback' => 'bxdev_sales_create_client_page',
		'file path' => drupal_get_path('module','user'),
    'file' => 'user.pages.inc',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

	$items['sales/add/project/%user'] = array(
	  'title' => t('Create a New Video Project'),
		'page callback' => 'bxdev_sales_create_project_page',
		'page arguments' => array(3),
		'file path' => drupal_get_path('module','node'),
    'file' => 'node.pages.inc',
	  'access arguments' => array('access content'),
	  'type' => MENU_CALLBACK,
	);

	$items['sales/get/form/%'] = array(
		'page callback' => 'bxdev_sales_get_form',
		'page arguments' => array(3),
		'file path' => drupal_get_path('module','user'),
    'file' => 'user.pages.inc',
    'access arguments' => array('access content'),
		'type' => MENU_CALLBACK,
	);

	$items['sales/autocomplete/clients'] = array(
		'page callback' => 'bxdev_sales_autocomplete_clients',
	  'access arguments' => array('access content'),
		'type' => MENU_CALLBACK,
	);

  return $items;
}


/**
 * FORMS
 */

/**
 * Form builder: existing client
 */
function bxdev_sales_existing_client_form($form, $form_state){
	$form['existing_client'] = array(
		'#type' => 'textfield',
		'#title' => t('Existing client'),
		'#autocomplete_path' => 'sales/autocomplete/clients',
		'#required' => TRUE,
	);
	
	$form['existing_client_nid'] = array(
	  '#type' => 'hidden',
	  '#default_value' => '',
	);	
	
	$form['submit'] = array(
	  '#type' => 'submit',
	  '#value' => t('Continue >'),
	);
	
	return $form;
	
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function bxdev_sales_form_bxdev_sales_existing_client_form_alter(&$form, $form_state){
	$form['#action'] = '/sales/add/client#existing';
}

/**
 * Form submit handler: existing client
 */
function bxdev_sales_existing_client_form_submit($form, &$form_state){
	$values = $form_state['values'];
	// $form_state['redirect'] = '/videographers';
	dpm($values);
}


/**
 * CUSTOM
 */

/**
 * Page callback: create client
 */
function bxdev_sales_create_client_page(){
	
	drupal_add_js(drupal_get_path('module', 'bxdev_sales') . '/bxdev_sales.js');
	
	$output = '<h2><strong>Business Profile Info</strong> (step 1 of 2)</h2>';
	$output .= '<div class="client-select">';
	$output .= '<a href="#new" class="show-client-add-form">New client</a>';
	$output .= '<a href="#existing" class="show-client-existing-form">Existing client</a>';
	$output .= '</div>';
	
	$output .= '<div class="client-add-form">' . drupal_render(drupal_get_form('user_register_form')) . '</div>';
	
	$output .= '<div class="client-existing-form" style="display:none;">' . drupal_render(drupal_get_form('bxdev_sales_existing_client_form')) . '</div>';
	
	return $output;
	
}

/**
 * Page callback: create project
 */
function bxdev_sales_create_project_page($user){
	
	dpm($user);
	
	$output = '';

	$output .= drupal_render(node_add('project'));
	
	
	return $output;
}

/**
 * Menu callback: sales get form
 */
function bxdev_sales_get_form($type){
	$output = '';
	switch($type){
		case 'new':
			$output .= '<div id="client-form">' . drupal_render(drupal_get_form('user_register_form')) . '</div>';
			break;
		
		case 'existing':
			$output .= '<div id="client-form">' . drupal_render(drupal_get_form('bxdev_sales_existing_client_form')) . '</div>';
			// $commands[] = ajax_command_invoke(NULL, 'bxdev_sales_autocomplete');
			break;
	}
	$commands[] = ajax_command_replace('#client-form', $output);
	$page = array('#type' => 'ajax', '#commands' => $commands);
	ajax_deliver($page);
}

/**
 * Menu callback: clients autocomplete
 */
function bxdev_sales_autocomplete_clients($string){
	$results = db_query("SELECT field_data_field_name.field_name_value as name, profile.uid as uid FROM {field_data_field_name} INNER JOIN {profile} ON field_data_field_name.entity_id = profile.pid WHERE field_data_field_name.bundle = 'client' AND field_data_field_name.field_name_value LIKE :string", array(':string' => $string . '%'));
	if($results->rowCount() > 0){
		$items = array();
		foreach($results as $client){
			$items[$client->uid] = $client->name;
		}
		drupal_json_output($items);
	}
}






